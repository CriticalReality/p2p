<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2P Lobby Test (WebRTC)</title>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>

<style>
body {
  margin: 0;
  background: #0b0b0b;
  color: #e0e0e0;
  font-family: system-ui, monospace;
}
button, input {
  background: #222;
  color: #e0e0e0;
  border: 1px solid #444;
  padding: 8px;
}
.hidden { display: none; }

#settingsBtn { position: absolute; top: 10px; right: 10px; }
#topLeftBtn { position: absolute; top: 10px; left: 10px; }

#center {
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 12px;
}

.panel {
  background: #161616;
  padding: 16px;
  border: 1px solid #333;
  min-width: 320px;
}

#devPanel {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #000;
  font-size: 12px;
  padding: 6px;
  border-top: 1px solid #333;
  white-space: pre-wrap;
}
</style>
</head>
<body>

<button id="settingsBtn">Settings</button>
<button id="topLeftBtn" class="hidden"></button>

<div id="center">
  <div id="lobbyActions" class="panel">
    <button onclick="openCreate()">Create Lobby</button>
    <button onclick="openJoin()">Join Lobby</button>
  </div>

  <div id="createPanel" class="panel hidden">
    <input id="createName" placeholder="Lobby name"><br><br>
    <input id="createPass" placeholder="Password (optional)"><br><br>
    <button onclick="createLobby()">Create</button>
  </div>

  <div id="joinPanel" class="panel hidden">
    <input id="joinName" placeholder="Lobby name"><br><br>
    <input id="joinPass" placeholder="Password"><br><br>
    <button onclick="joinLobby()">Join</button>
  </div>

  <div id="settingsPanel" class="panel hidden">
    <input id="usernameInput" placeholder="Username"><br><br>
    <label><input type="checkbox" id="devToggle"> Dev Mode</label>
  </div>

  <div id="lobbyView" class="panel hidden">
    <h3 id="lobbyTitle"></h3>
    <div id="memberList"></div>
  </div>
</div>

<div id="devPanel" class="hidden"></div>

<script>
/* ---------- STATE ---------- */
const state = {
  username: "User",
  dev: false,
  isHost: false,
  lobby: null,
  password: null,
  peers: [],
  members: []
};

const TRACKERS = [
  "wss://tracker.openwebtorrent.com",
  "wss://tracker.btorrent.xyz",
  "wss://tracker.fastcast.nz"
];

/* ---------- UTILS ---------- */
function hash(str) {
  return btoa(str).slice(0, 20);
}
function logDev(msg) {
  if (!state.dev) return;
  devPanel.textContent += msg + "\n";
}
function show(id){ document.getElementById(id).classList.remove("hidden"); }
function hide(id){ document.getElementById(id).classList.add("hidden"); }

/* ---------- SETTINGS ---------- */
settingsBtn.onclick = () => toggle("settingsPanel");
devToggle.onchange = e => {
  state.dev = e.target.checked;
  devPanel.classList.toggle("hidden", !state.dev);
};
usernameInput.oninput = e => state.username = e.target.value || "User";

/* ---------- PANELS ---------- */
function toggle(id){
  ["createPanel","joinPanel","settingsPanel"].forEach(hide);
  show(id);
}
function openCreate(){ toggle("createPanel"); }
function openJoin(){ toggle("joinPanel"); }

/* ---------- WEBRTC CORE ---------- */
function createPeer(initiator, topic) {
  const peer = new SimplePeer({
    initiator,
    trickle: true,
    config: { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] }
  });

  peer.on("signal", data => {
    localStorage.setItem(topic + "_signal", JSON.stringify(data));
  });

  peer.on("connect", () => {
    logDev("DataChannel connected");
    peer.send(JSON.stringify({ type:"join", name: state.username }));
  });

  peer.on("data", data => handleMessage(peer, data));
  peer.on("iceStateChange", s => logDev("ICE: " + s));

  state.peers.push(peer);
  return peer;
}

/* ---------- MESSAGE HANDLING ---------- */
function handleMessage(peer, raw) {
  const msg = JSON.parse(raw);
  if (msg.type === "join" && state.isHost) {
    if (state.password && msg.pass !== state.password) return;
    state.members.push(msg.name);
    broadcast();
  }
  if (msg.type === "sync") {
    state.members = msg.members;
    renderMembers();
  }
}

/* ---------- LOBBY FLOW ---------- */
function createLobby() {
  state.lobby = createName.value.trim();
  state.password = createPass.value;
  state.isHost = true;
  state.members = [state.username];

  enterLobby();

  const topic = hash(state.lobby);
  const peer = createPeer(true, topic);

  window.addEventListener("storage", e => {
    if (e.key === topic + "_signal") {
      peer.signal(JSON.parse(e.newValue));
    }
  });

  logDev("Host advertising lobby");
}

function joinLobby() {
  state.lobby = joinName.value.trim();
  state.password = joinPass.value;
  state.isHost = false;

  enterLobby();

  const topic = hash(state.lobby);
  const peer = createPeer(false, topic);

  window.addEventListener("storage", e => {
    if (e.key === topic + "_signal") {
      peer.signal(JSON.parse(e.newValue));
    }
  });

  peer.on("connect", () => {
    peer.send(JSON.stringify({
      type:"join",
      name: state.username,
      pass: state.password
    }));
  });

  logDev("Attempting peer discovery");
}

function broadcast() {
  state.peers.forEach(p => {
    p.send(JSON.stringify({ type:"sync", members: state.members }));
  });
  renderMembers();
}

/* ---------- UI ---------- */
function enterLobby() {
  hide("lobbyActions");
  hide("createPanel");
  hide("joinPanel");
  hide("settingsPanel");
  show("lobbyView");

  lobbyTitle.textContent = state.lobby;
  renderMembers();

  topLeftBtn.textContent = state.isHost ? "Dispose Lobby" : "Leave Lobby";
  topLeftBtn.onclick = exitLobby;
  show("topLeftBtn");
}

function renderMembers() {
  memberList.innerHTML = "";
  state.members.forEach((m,i)=>{
    const d=document.createElement("div");
    d.textContent=(i===0?"HOST: ":"")+m;
    memberList.appendChild(d);
  });
}

function exitLobby() {
  state.peers.forEach(p=>p.destroy());
  state.peers=[];
  state.members=[];
  hide("lobbyView");
  show("lobbyActions");
  hide("topLeftBtn");
  logDev("Lobby closed");
}
</script>
</body>
</html>
